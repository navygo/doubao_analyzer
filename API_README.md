# è±†åŒ…åª’ä½“åˆ†æAPIæœåŠ¡å™¨

è±†åŒ…åª’ä½“åˆ†æå·¥å…·çš„APIæœåŠ¡å™¨ç‰ˆæœ¬ï¼Œæä¾›HTTPæ¥å£ä¾›ä¸‰æ–¹ç³»ç»Ÿè°ƒç”¨ï¼Œå®ç°å›¾ç‰‡å’Œè§†é¢‘çš„æ™ºèƒ½åˆ†æåŠŸèƒ½ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ–¼ï¸ **å›¾ç‰‡åˆ†æ**: é€šè¿‡URLåˆ†æå›¾ç‰‡å†…å®¹
- ğŸ¬ **è§†é¢‘åˆ†æ**: é€šè¿‡URLåˆ†æè§†é¢‘å†…å®¹
- ğŸ“ **æ ‡ç­¾æå–**: è‡ªåŠ¨ä»åˆ†æç»“æœä¸­æå–æ ‡ç­¾
- ğŸ’¾ **æ•°æ®åº“å­˜å‚¨**: æ”¯æŒå°†åˆ†æç»“æœå­˜å‚¨åˆ°MySQLæ•°æ®åº“
- ğŸŒ **RESTful API**: æä¾›ç®€å•çš„HTTPæ¥å£
- ğŸ” **ç»“æœæŸ¥è¯¢**: æ”¯æŒå¤šç§æŸ¥è¯¢æ–¹å¼æ£€ç´¢å·²åˆ†æçš„ç»“æœ

## å®‰è£…ä¸ç¼–è¯‘

### 1. ç¼–è¯‘é¡¹ç›®
```bash
mkdir build && cd build
cmake ..
make -j$(nproc)
```

### 2. å®‰è£…åˆ°ç³»ç»Ÿ
```bash
sudo make install
```

## ä½¿ç”¨æ–¹æ³•

### å¯åŠ¨APIæœåŠ¡å™¨
```bash
# åŸºæœ¬ç”¨æ³•
doubao_api_server --api-key YOUR_API_KEY

# è‡ªå®šä¹‰ç«¯å£å’Œä¸»æœº
doubao_api_server --api-key YOUR_API_KEY --port 8080 --host 0.0.0.0

# æŸ¥çœ‹å¸®åŠ©
doubao_api_server --help
```

### APIæ¥å£

#### è®¤è¯ï¼ˆBearer JWTï¼‰

æœ¬æœåŠ¡ä½¿ç”¨åŸºäº `Bearer JWT` çš„ç®€å•è®¤è¯æ–¹æ¡ˆã€‚é»˜è®¤æœ‰ä¸¤ä¸ªç¯å¢ƒå˜é‡ç”¨äºç™»å½•éªŒè¯ï¼ˆä»…ç¤ºä¾‹ï¼‰:

- `ADMIN_USER`ï¼ˆé»˜è®¤: `admin`ï¼‰
- `ADMIN_PASS`ï¼ˆé»˜è®¤: `password`ï¼‰

è·å– tokenï¼š

è¯·æ±‚: `POST /api/auth`

è¯·æ±‚ç¤ºä¾‹:
```json
{ "username": "admin", "password": "password" }
```

å“åº”ç¤ºä¾‹:
```json
{ "success": true, "data": { "token": "<JWT>", "expires_in": 900 } }
```

ä½¿ç”¨ token è°ƒç”¨å—ä¿æŠ¤æ¥å£æ—¶åœ¨ HTTP å¤´åŠ å…¥ï¼š
```
Authorization: Bearer <JWT>
```

ç¤ºä¾‹ curlï¼š
```bash
# ç™»å½•è·å– token
curl -s -X POST http://localhost:8080/api/auth -d '{"username":"admin","password":"password"}' \
    -H "Content-Type: application/json"

# ä½¿ç”¨ token è°ƒç”¨å—ä¿æŠ¤æ¥å£
TOKEN=eyJ... # ä»ç™»å½•å“åº”è·å–
curl -s -X POST http://localhost:8080/api/analyze -d '{"media_type":"image","media_url":"https://..."}' \
    -H "Content-Type: application/json" -H "Authorization: Bearer $TOKEN"
```


#### åˆ†ææ¥å£ - POST /api/analyze

åˆ†æå›¾ç‰‡æˆ–è§†é¢‘å†…å®¹ã€‚

**è¯·æ±‚ç¤ºä¾‹:**
```json
{
    "media_type": "image",
    "media_url": "https://example.com/image.jpg",
    "prompt": "è¯·åˆ†æè¿™å¼ å›¾ç‰‡çš„å†…å®¹",
    "max_tokens": 1500,
    "save_to_db": true
}
```

**å“åº”ç¤ºä¾‹:**
```json
{
    "success": true,
    "message": "å›¾ç‰‡åˆ†ææˆåŠŸ",
    "response_time": 2.3,
    "data": {
        "content": "è¿™å¼ å›¾ç‰‡å±•ç¤ºäº†ä¸€åº§ç¾ä¸½çš„å±±å³°...",
        "tags": ["å±±å³°", "è‡ªç„¶", "é£æ™¯"],
        "response_time": 2.1,
        "usage": {
            "prompt_tokens": 120,
            "completion_tokens": 150,
            "total_tokens": 270
        },
        "saved_to_db": true
    }
}
```

#### æŸ¥è¯¢æ¥å£ - POST /api/query

æŸ¥è¯¢å·²åˆ†æçš„ç»“æœè®°å½•ï¼Œæ”¯æŒå¤šç§æŸ¥è¯¢æ–¹å¼ã€‚

**è¯·æ±‚ç¤ºä¾‹:**
```json
{
    "query_type": "tag",
    "tag": "é£æ™¯"
}
```

**å“åº”ç¤ºä¾‹:**
```json
{
    "success": true,
    "message": "æŸ¥è¯¢æˆåŠŸï¼Œå…±æ‰¾åˆ° 5 æ¡è®°å½•",
    "response_time": 0.2,
    "data": {
        "results": [
            {
                "id": 1,
                "file_path": "https://example.com/image1.jpg",
                "file_name": "image1.jpg",
                "file_type": "image",
                "analysis_result": "è¿™å¼ å›¾ç‰‡å±•ç¤ºäº†ä¸€åº§ç¾ä¸½çš„å±±å³°...",
                "tags": "å±±å³°, è‡ªç„¶, é£æ™¯",
                "response_time": 2.1,
                "created_at": "2023-07-15 14:30:22"
            },
            {
                "id": 3,
                "file_path": "https://example.com/image2.jpg",
                "file_name": "image2.jpg",
                "file_type": "image",
                "analysis_result": "è¿™æ˜¯ä¸€ç‰‡å®é™çš„æ¹–æ³Šï¼Œå‘¨å›´ç¯ç»•ç€é’å±±...",
                "tags": "æ¹–æ³Š, è‡ªç„¶, é£æ™¯",
                "response_time": 1.8,
                "created_at": "2023-07-15 15:45:10"
            }
        ],
        "count": 5
    }
}
```

#### çŠ¶æ€æ¥å£ - GET /api/status

è·å–æœåŠ¡å™¨çŠ¶æ€å’Œæ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯ã€‚

**å“åº”ç¤ºä¾‹:**
```json
{
    "success": true,
    "message": "æœåŠ¡å™¨çŠ¶æ€æŸ¥è¯¢æˆåŠŸ",
    "response_time": 0.0,
    "data": {
        "server_status": "running",
        "api_key_set": true,
        "port": 8080,
        "host": "0.0.0.0",
        "database_stats": {
            "total_records": 125,
            "image_records": 78,
            "video_records": 47,
            "last_updated": "2023-07-15 16:20:05"
        }
    }
}
```

### è¯·æ±‚å‚æ•°è¯´æ˜

#### åˆ†ææ¥å£å‚æ•°

| å‚æ•° | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|------|
| media_type | string | æ˜¯ | åª’ä½“ç±»å‹ï¼Œ"image"æˆ–"video" |
| media_url | string | æ˜¯ | å›¾ç‰‡æˆ–è§†é¢‘çš„URLåœ°å€ |
| prompt | string | å¦ | è‡ªå®šä¹‰æç¤ºè¯ï¼Œç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤æç¤ºè¯ |
| max_tokens | int | å¦ | æœ€å¤§ä»¤ç‰Œæ•°ï¼Œå›¾ç‰‡é»˜è®¤1500ï¼Œè§†é¢‘é»˜è®¤2000 |
| video_frames | int | å¦ | è§†é¢‘æå–å¸§æ•°ï¼Œä»…è§†é¢‘åˆ†ææœ‰æ•ˆï¼Œé»˜è®¤ä¸º5 |
| save_to_db | bool | å¦ | æ˜¯å¦å°†ç»“æœä¿å­˜åˆ°æ•°æ®åº“ï¼Œé»˜è®¤ä¸ºtrue |

#### æŸ¥è¯¢æ¥å£å‚æ•°

| å‚æ•° | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|------|
| query_type | string | æ˜¯ | æŸ¥è¯¢ç±»å‹ï¼š"all", "tag", "type", "date_range", "recent", "url" |
| tag | string | å¦ | è¦æŸ¥è¯¢çš„æ ‡ç­¾ï¼ˆå½“query_typeä¸º"tag"æ—¶ä½¿ç”¨ï¼‰ |
| file_type | string | å¦ | è¦æŸ¥è¯¢çš„æ–‡ä»¶ç±»å‹ï¼ˆå½“query_typeä¸º"type"æ—¶ä½¿ç”¨ï¼‰ |
| start_date | string | å¦ | å¼€å§‹æ—¥æœŸï¼ˆå½“query_typeä¸º"date_range"æ—¶ä½¿ç”¨ï¼‰ |
| end_date | string | å¦ | ç»“æŸæ—¥æœŸï¼ˆå½“query_typeä¸º"date_range"æ—¶ä½¿ç”¨ï¼‰ |
| limit | int | å¦ | è¿”å›ç»“æœæ•°é‡é™åˆ¶ï¼ˆå½“query_typeä¸º"recent"æ—¶ä½¿ç”¨ï¼Œé»˜è®¤10ï¼‰ |
| condition | string | å¦ | è‡ªå®šä¹‰æŸ¥è¯¢æ¡ä»¶ï¼ˆå½“query_typeä¸º"all"æ—¶ä½¿ç”¨ï¼‰ |
| media_url | string | å¦ | è¦æŸ¥è¯¢çš„åª’ä½“URLï¼ˆå½“query_typeä¸º"url"æ—¶ä½¿ç”¨ï¼‰ |

### æŸ¥è¯¢ç±»å‹è¯´æ˜

- **all**: æŸ¥è¯¢æ‰€æœ‰ç»“æœï¼Œå¯ä½¿ç”¨conditionå‚æ•°æ·»åŠ è‡ªå®šä¹‰æ¡ä»¶
- **tag**: æ ¹æ®æ ‡ç­¾æŸ¥è¯¢ï¼Œéœ€è¦æä¾›tagå‚æ•°
- **type**: æ ¹æ®æ–‡ä»¶ç±»å‹æŸ¥è¯¢ï¼ˆ"image"æˆ–"video"ï¼‰ï¼Œéœ€è¦æä¾›file_typeå‚æ•°
- **date_range**: æ ¹æ®æ—¥æœŸèŒƒå›´æŸ¥è¯¢ï¼Œéœ€è¦æä¾›start_dateå’Œend_dateå‚æ•°
- **recent**: è·å–æœ€è¿‘çš„è®°å½•ï¼Œå¯ä½¿ç”¨limitå‚æ•°é™åˆ¶è¿”å›æ•°é‡
- **url**: æ ¹æ®åª’ä½“URLæŸ¥è¯¢ï¼Œéœ€è¦æä¾›media_urlå‚æ•°

### é”™è¯¯å“åº”ç¤ºä¾‹

```json
{
    "success": false,
    "message": "å›¾ç‰‡ä¸‹è½½å¤±è´¥: https://example.com/image.jpg",
    "error": "Image download failed",
    "response_time": 0.5
}
```

## æ•°æ®åº“é…ç½®

APIæœåŠ¡å™¨ä½¿ç”¨ä¸å‘½ä»¤è¡Œå·¥å…·ç›¸åŒçš„æ•°æ®åº“é…ç½®ã€‚è¯·ç¡®ä¿å·²æ­£ç¡®é…ç½®MySQLæ•°æ®åº“ï¼Œè¯¦è§ä¸»READMEæ–‡æ¡£ä¸­çš„æ•°æ®åº“é…ç½®éƒ¨åˆ†ã€‚

## æ³¨æ„äº‹é¡¹

1. æœåŠ¡å™¨ä¼šè‡ªåŠ¨ä¸‹è½½URLæŒ‡å®šçš„åª’ä½“æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•ï¼Œåˆ†æå®Œæˆåè‡ªåŠ¨åˆ é™¤
2. ä¸‹è½½è¶…æ—¶è®¾ç½®ä¸º5åˆ†é’Ÿï¼Œå¤§æ–‡ä»¶å¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´
3. ç¡®ä¿æœåŠ¡å™¨æœ‰è¶³å¤Ÿçš„ä¸´æ—¶å­˜å‚¨ç©ºé—´
4. APIæœåŠ¡å™¨é»˜è®¤ç›‘å¬8080ç«¯å£ï¼Œå¯é€šè¿‡--portå‚æ•°ä¿®æ”¹
5. é»˜è®¤ç»‘å®šåˆ°0.0.0.0ï¼Œå…è®¸å¤–éƒ¨è®¿é—®ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨é˜²ç«å¢™é™åˆ¶è®¿é—®
6. æŸ¥è¯¢ç»“æœä¸­åŒ…å«å®Œæ•´åˆ†æå†…å®¹ï¼Œå¯èƒ½è¾ƒå¤§ï¼Œå»ºè®®å®¢æˆ·ç«¯åˆç†å¤„ç†

## æ•…éšœæ’é™¤

- **è¿æ¥å¤±è´¥**: æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æ­£ç¡®ï¼Œç½‘ç»œæ˜¯å¦é€šç•…
- **ä¸‹è½½å¤±è´¥**: ç¡®è®¤URLæ˜¯å¦å¯è®¿é—®ï¼Œæ–‡ä»¶æ˜¯å¦è¿‡å¤§
- **æ•°æ®åº“é”™è¯¯**: æ£€æŸ¥æ•°æ®åº“é…ç½®æ˜¯å¦æ­£ç¡®ï¼ŒMySQLæœåŠ¡æ˜¯å¦è¿è¡Œ
- **ç«¯å£å ç”¨**: ä½¿ç”¨--portå‚æ•°æŒ‡å®šå…¶ä»–ç«¯å£
- **æŸ¥è¯¢æ— ç»“æœ**: æ£€æŸ¥æŸ¥è¯¢æ¡ä»¶æ˜¯å¦æ­£ç¡®ï¼Œç¡®è®¤æ•°æ®åº“ä¸­æ˜¯å¦æœ‰åŒ¹é…è®°å½•

## è®¸å¯è¯

MIT License
